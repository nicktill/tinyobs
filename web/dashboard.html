<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyObs - Observability Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-orange: #f0883e;
            --accent-red: #f85149;
            --accent-purple: #bc8cff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            color: var(--accent-blue);
            font-size: 1.5rem;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.875rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            padding: 0 2rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.02);
        }

        .nav-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .toolbar-left {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        input, select, button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            outline: none;
        }

        input:focus, select:focus {
            border-color: var(--accent-blue);
        }

        button {
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--border-color);
        }

        button.primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #000;
        }

        button.primary:hover {
            opacity: 0.9;
        }

        select {
            min-width: 150px;
        }

        .time-range-selector {
            display: flex;
            gap: 0.5rem;
        }

        .time-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        .time-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #000;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
        }

        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1.5rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-subtitle {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 0.375rem 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            border-radius: 4px;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .metrics-browser {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .metric-row {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .metric-row::before {
            content: '‚óã';
            position: absolute;
            left: 0.75rem;
            top: 1rem;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .metric-row.selected::before {
            content: '‚óè';
            color: var(--accent-blue);
        }

        .metric-row:hover {
            border-color: var(--accent-blue);
            background: rgba(88, 166, 255, 0.05);
        }

        .metric-row.selected {
            border-color: var(--accent-blue);
            background: rgba(88, 166, 255, 0.1);
        }

        .metric-content {
            margin-left: 1.5rem;
        }

        .metric-name {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.9375rem;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .metric-labels {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .label {
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .label-key {
            color: var(--accent-green);
        }

        .label-value {
            color: var(--accent-orange);
        }

        .metric-value {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1.5rem;
        }

        .value-label {
            color: var(--text-secondary);
            margin-right: 0.25rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading {
            color: var(--text-secondary);
            padding: 2rem;
            text-align: center;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .badge {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.success {
            background: rgba(63, 185, 80, 0.1);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .service-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .service-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .service-icon {
            font-size: 1.25rem;
        }

        .collapse-icon {
            transition: transform 0.2s;
        }

        .service-section.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .service-section.collapsed .service-charts {
            display: none;
        }

        .service-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .help-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: help;
            font-size: 0.875rem;
            position: relative;
        }

        .help-btn:hover {
            color: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .help-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            padding: 1rem;
            min-width: 250px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .help-btn:hover .help-tooltip {
            display: block;
        }

        .help-tooltip h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-blue);
            font-size: 0.875rem;
        }

        .help-tooltip ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .help-tooltip li {
            padding: 0.25rem 0;
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .help-tooltip kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 0.125rem 0.375rem;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.75rem;
            color: var(--accent-green);
        }

        @media (max-width: 768px) {
            .header-stats {
                display: none;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left, .toolbar-right {
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .service-charts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="logo">
                <span class="logo-icon">‚óè</span>
                <span>TinyObs</span>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-label">Total Metrics</div>
                    <div class="stat-value" id="totalMetrics">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Series</div>
                    <div class="stat-value" id="totalSeries">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Storage</div>
                    <div class="stat-value" id="storageSize">-</div>
                </div>
                <div class="help-btn">
                    ?
                    <div class="help-tooltip">
                        <h4>Keyboard Shortcuts</h4>
                        <ul>
                            <li><kbd>R</kbd> Refresh current view</li>
                            <li><kbd>/</kbd> Focus search (Explore)</li>
                            <li><kbd>ESC</kbd> Clear selection (Explore)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="switchView('explore')">Explore Metrics</button>
        </nav>
    </div>

    <div class="container">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view active">
            <div class="toolbar">
                <div class="toolbar-left">
                    <select id="serviceFilter" onchange="filterDashboard()">
                        <option value="all">All Services</option>
                    </select>
                    <select id="endpointFilter" onchange="filterDashboard()">
                        <option value="all">All Endpoints</option>
                    </select>
                    <select id="metricNameFilter" onchange="filterDashboard()">
                        <option value="all">All Metrics</option>
                    </select>
                    <div class="time-range-selector">
                        <button class="time-btn" data-range="1h" onclick="setTimeRange('1h')">1h</button>
                        <button class="time-btn" data-range="6h" onclick="setTimeRange('6h')">6h</button>
                        <button class="time-btn active" data-range="24h" onclick="setTimeRange('24h')">24h</button>
                        <button class="time-btn" data-range="7d" onclick="setTimeRange('7d')">7d</button>
                    </div>
                </div>
                <div class="toolbar-right">
                    <button class="primary" onclick="refreshDashboard()">‚Üª Refresh</button>
                </div>
            </div>

            <div id="dashboardContent">
                <div class="loading">Loading dashboard</div>
            </div>
        </div>

        <!-- Explore View -->
        <div id="explore-view" class="view">
            <div class="toolbar">
                <div class="toolbar-left">
                    <input type="text" id="searchBox" placeholder="Search metrics..." style="width: 300px;">
                    <select id="metricTypeFilter" onchange="filterMetrics()">
                        <option value="all">All Types</option>
                        <option value="counter">Counters</option>
                        <option value="gauge">Gauges</option>
                        <option value="histogram">Histograms</option>
                    </select>
                    <select id="exploreServiceFilter" onchange="filterMetrics()">
                        <option value="all">All Services</option>
                    </select>
                </div>
                <div class="toolbar-right">
                    <span class="badge success" id="selectedCount">0 selected</span>
                    <button onclick="clearSelection()">Clear</button>
                    <button class="primary" onclick="refreshMetrics()">‚Üª Refresh</button>
                </div>
            </div>

            <div id="metricsBrowser" class="metrics-browser">
                <div class="loading">Loading metrics</div>
            </div>

            <div id="selectedChart" style="display: none; margin-top: 1.5rem;">
                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Selected Metrics</div>
                            <div class="chart-subtitle">Time series comparison</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="exploreChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let metricsData = [];
        let selectedMetrics = new Set();
        let currentRange = '24h';
        let charts = {};
        let exploreChart = null;
        let currentView = 'dashboard';

        Chart.defaults.color = '#8b949e';
        Chart.defaults.borderColor = '#30363d';

        // Color palette for consistent chart colors
        const COLOR_PALETTE = [
            '#58a6ff', '#3fb950', '#f0883e', '#f85149', '#bc8cff',
            '#ff7b72', '#79c0ff', '#56d364', '#ffa657', '#f778ba',
            '#a5d6ff', '#7ee787', '#ffbc6f', '#ff9492', '#d2a8ff'
        ];

        // Hash function for stable color assignment
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        // Get stable color for a metric series
        function getStableColor(metricName, labels) {
            const key = metricName + JSON.stringify(labels || {});
            const hash = hashString(key);
            return COLOR_PALETTE[hash % COLOR_PALETTE.length];
        }

        // View Switching
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            document.getElementById(`${view}-view`).classList.add('active');
            event.target.classList.add('active');

            if (view === 'dashboard') {
                loadDashboard();
            } else {
                loadMetrics();
            }
        }

        // Time Range
        function setTimeRange(range) {
            currentRange = range;
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (currentView === 'dashboard') {
                refreshDashboard();
            } else if (selectedMetrics.size > 0) {
                renderExploreChart();
            }
        }

        // Stats
        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + sizes[i];
        }

        function formatValue(value) {
            if (typeof value !== 'number') return value;
            if (value >= 1000000) return (value / 1000000).toFixed(2) + 'M';
            if (value >= 1000) return (value / 1000).toFixed(2) + 'K';
            return value.toFixed(2);
        }

        async function loadStats() {
            try {
                const [statsRes, storageRes] = await Promise.all([
                    fetch('/v1/stats'),
                    fetch('/v1/storage')
                ]);

                if (statsRes.ok) {
                    const stats = await statsRes.json();
                    document.getElementById('totalMetrics').textContent = stats.TotalMetrics?.toLocaleString() || '0';
                    document.getElementById('totalSeries').textContent = stats.TotalSeries?.toLocaleString() || '0';
                }

                if (storageRes.ok) {
                    const storage = await storageRes.json();
                    const usedPct = ((storage.used_bytes / storage.max_bytes) * 100).toFixed(1);
                    document.getElementById('storageSize').textContent =
                        formatBytes(storage.used_bytes) + ' / ' + formatBytes(storage.max_bytes) + ' (' + usedPct + '%)';
                }
            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        // Dashboard View
        async function loadDashboard() {
            const container = document.getElementById('dashboardContent');
            container.innerHTML = '<div class="loading">Loading dashboard</div>';

            try {
                const now = Date.now();
                const ranges = { '1h': 1, '6h': 6, '24h': 24, '7d': 168 };
                const hours = ranges[currentRange];
                const start = new Date(now - hours * 60 * 60 * 1000).toISOString();
                const end = new Date(now).toISOString();

                const response = await fetch(`/v1/query?start=${start}&end=${end}`);
                if (!response.ok) throw new Error('Query failed');

                const data = await response.json();
                metricsData = data.metrics || [];

                // Extract unique services, endpoints, and metric names
                const services = {};
                const endpoints = new Set();
                const metricNames = new Set();

                metricsData.forEach(m => {
                    const service = m.labels?.service || m.labels?.__service || 'default';
                    if (!services[service]) services[service] = [];
                    services[service].push(m);

                    // Collect endpoints
                    if (m.labels?.endpoint) endpoints.add(m.labels.endpoint);
                    if (m.labels?.path) endpoints.add(m.labels.path);

                    // Collect metric names
                    metricNames.add(m.name);
                });

                // Update all filters
                updateDashboardFilters(Object.keys(services), Array.from(endpoints).sort(), Array.from(metricNames).sort());

                // Render service sections
                renderDashboard(services);
            } catch (error) {
                console.error('Dashboard error:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Failed to load dashboard</p></div>';
            }
        }

        function updateDashboardFilters(services, endpoints, metricNames) {
            // Update service filters
            const serviceFilter = document.getElementById('serviceFilter');
            const exploreServiceFilter = document.getElementById('exploreServiceFilter');
            const serviceOptions = services.map(s => `<option value="${s}">${s}</option>`).join('');
            serviceFilter.innerHTML = '<option value="all">All Services</option>' + serviceOptions;
            exploreServiceFilter.innerHTML = '<option value="all">All Services</option>' + serviceOptions;

            // Update endpoint filter
            const endpointFilter = document.getElementById('endpointFilter');
            const endpointOptions = endpoints.map(e => `<option value="${e}">${e}</option>`).join('');
            endpointFilter.innerHTML = '<option value="all">All Endpoints</option>' + endpointOptions;

            // Update metric name filter
            const metricNameFilter = document.getElementById('metricNameFilter');
            const metricOptions = metricNames.map(m => `<option value="${m}">${m}</option>`).join('');
            metricNameFilter.innerHTML = '<option value="all">All Metrics</option>' + metricOptions;
        }

        function renderDashboard(services) {
            const container = document.getElementById('dashboardContent');
            const selectedService = document.getElementById('serviceFilter').value;
            const selectedEndpoint = document.getElementById('endpointFilter').value;
            const selectedMetricName = document.getElementById('metricNameFilter').value;

            const servicesToShow = selectedService === 'all'
                ? Object.entries(services)
                : [[selectedService, services[selectedService]]].filter(([_, v]) => v);

            if (servicesToShow.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><p>No metrics for this service</p></div>';
                return;
            }

            container.innerHTML = servicesToShow.map(([service, metrics]) => {
                // Apply filters
                let filteredMetrics = metrics;

                if (selectedEndpoint !== 'all') {
                    filteredMetrics = filteredMetrics.filter(m =>
                        m.labels?.endpoint === selectedEndpoint || m.labels?.path === selectedEndpoint
                    );
                }

                if (selectedMetricName !== 'all') {
                    filteredMetrics = filteredMetrics.filter(m => m.name === selectedMetricName);
                }

                // Group metrics by name
                const grouped = {};
                filteredMetrics.forEach(m => {
                    if (!grouped[m.name]) grouped[m.name] = [];
                    grouped[m.name].push(m);
                });

                if (Object.keys(grouped).length === 0) {
                    return ''; // Skip this service if no metrics match filters
                }

                const chartCards = Object.entries(grouped).slice(0, 6).map(([name, data], idx) => {
                    const chartId = `chart-${service}-${name.replace(/[^a-zA-Z0-9]/g, '-')}-${idx}`;
                    return `
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <div class="chart-title">${name}</div>
                                    <div class="chart-subtitle">${data.length} series</div>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="${chartId}"></canvas>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="service-section" id="service-${service}">
                        <div class="service-header" onclick="toggleService('${service}')">
                            <h3>
                                <span class="service-icon">üì¶</span>
                                ${service}
                                <span class="badge">${Object.keys(grouped).length} metrics</span>
                            </h3>
                            <span class="collapse-icon">‚ñº</span>
                        </div>
                        <div class="service-charts">
                            ${chartCards}
                        </div>
                    </div>
                `;
            }).join('');

            // Render charts after DOM update
            setTimeout(() => {
                servicesToShow.forEach(([service, metrics]) => {
                    const grouped = {};
                    metrics.forEach(m => {
                        if (!grouped[m.name]) grouped[m.name] = [];
                        grouped[m.name].push(m);
                    });

                    Object.entries(grouped).slice(0, 6).forEach(([name, data], idx) => {
                        const chartId = `chart-${service}-${name.replace(/[^a-zA-Z0-9]/g, '-')}-${idx}`;
                        renderServiceChart(chartId, name, data);
                    });
                });
            }, 100);
        }

        async function renderServiceChart(canvasId, metricName, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            try {
                const now = Date.now();
                const ranges = { '1h': 1, '6h': 6, '24h': 24, '7d': 168 };
                const hours = ranges[currentRange];
                const start = new Date(now - hours * 60 * 60 * 1000).toISOString();
                const end = new Date(now).toISOString();

                const response = await fetch(`/v1/query/range?metric=${encodeURIComponent(metricName)}&start=${start}&end=${end}&maxPoints=200`);
                if (!response.ok) return;

                const result = await response.json();
                if (!result.data || result.data.length === 0) return;

                const datasets = result.data.slice(0, 5).map((series) => {
                    const color = getStableColor(series.metric, series.labels);
                    return {
                        label: series.labels && Object.keys(series.labels).length > 0
                            ? Object.entries(series.labels).filter(([k]) => !k.startsWith('__')).map(([k, v]) => `${k}="${v}"`).join(', ')
                            : metricName,
                        data: series.points.map(p => ({ x: p.t, y: p.v })),
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    };
                });

                if (charts[canvasId]) charts[canvasId].destroy();

                charts[canvasId] = new Chart(canvas, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#161b22',
                                borderColor: '#30363d',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                grid: { color: '#30363d' },
                                ticks: { color: '#8b949e', maxTicksLimit: 6 }
                            },
                            y: {
                                grid: { color: '#30363d' },
                                ticks: { color: '#8b949e' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Chart render error:', error);
            }
        }

        function toggleService(service) {
            const section = document.getElementById(`service-${service}`);
            section.classList.toggle('collapsed');
        }

        function filterDashboard() {
            const services = {};
            metricsData.forEach(m => {
                const service = m.labels?.service || m.labels?.__service || 'default';
                if (!services[service]) services[service] = [];
                services[service].push(m);
            });
            renderDashboard(services);
        }

        function refreshDashboard() {
            loadDashboard();
        }

        // Explore View
        async function loadMetrics() {
            try {
                const now = Date.now();
                const ranges = { '1h': 1, '6h': 6, '24h': 24, '7d': 168 };
                const hours = ranges[currentRange];
                const start = new Date(now - hours * 60 * 60 * 1000).toISOString();
                const end = new Date(now).toISOString();

                const response = await fetch(`/v1/query?start=${start}&end=${end}`);
                if (!response.ok) throw new Error('Query failed');

                const data = await response.json();
                metricsData = data.metrics || [];

                renderMetricsBrowser();
            } catch (error) {
                console.error('Load metrics error:', error);
                document.getElementById('metricsBrowser').innerHTML =
                    '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Failed to load metrics</p></div>';
            }
        }

        function renderMetricsBrowser() {
            const browser = document.getElementById('metricsBrowser');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const typeFilter = document.getElementById('metricTypeFilter').value;
            const serviceFilter = document.getElementById('exploreServiceFilter').value;

            if (!metricsData || metricsData.length === 0) {
                browser.innerHTML = '<div class="empty-state"><div class="empty-icon">üìä</div><p>No metrics available</p></div>';
                return;
            }

            // Group metrics
            const grouped = {};
            metricsData.forEach(m => {
                const key = seriesKey(m);
                if (!grouped[key]) {
                    grouped[key] = {
                        name: m.name,
                        labels: m.labels || {},
                        values: []
                    };
                }
                grouped[key].values.push(m);
            });

            // Filter
            const filtered = Object.entries(grouped).filter(([key, data]) => {
                const matchesSearch = data.name.toLowerCase().includes(searchTerm);
                const matchesType = typeFilter === 'all' || inferMetricType(data.name) === typeFilter;
                const service = data.labels?.service || data.labels?.__service || 'default';
                const matchesService = serviceFilter === 'all' || service === serviceFilter;
                return matchesSearch && matchesType && matchesService;
            });

            if (filtered.length === 0) {
                browser.innerHTML = '<div class="empty-state"><p>No metrics match your filters</p></div>';
                return;
            }

            browser.innerHTML = filtered.map(([key, data]) => {
                const latest = data.values[data.values.length - 1];
                const isSelected = selectedMetrics.has(key);
                const escapedKey = key.replace(/"/g, '&quot;');

                const labelsHtml = Object.keys(data.labels).length > 0
                    ? Object.entries(data.labels)
                        .filter(([k]) => !k.startsWith('__'))
                        .map(([k, v]) => `<div class="label"><span class="label-key">${k}</span>=<span class="label-value">"${v}"</span></div>`)
                        .join('')
                    : '<div class="label">no labels</div>';

                return `
                    <div class="metric-row ${isSelected ? 'selected' : ''}" data-key="${escapedKey}" onclick="toggleMetric(this, '${escapedKey}')">
                        <div class="metric-content">
                            <div class="metric-name">${data.name}</div>
                            <div class="metric-labels">${labelsHtml}</div>
                            <div class="metric-value">
                                <div><span class="value-label">Latest:</span>${formatValue(latest.value)}</div>
                                <div><span class="value-label">Samples:</span>${data.values.length}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function seriesKey(metric) {
            const labels = metric.labels ? JSON.stringify(metric.labels) : '';
            return `${metric.name}${labels}`;
        }

        function inferMetricType(name) {
            if (name.includes('_total') || name.includes('_count')) return 'counter';
            if (name.includes('_bucket') || name.includes('_duration')) return 'histogram';
            return 'gauge';
        }

        function toggleMetric(element, key) {
            const decodedKey = key.replace(/&quot;/g, '"');

            if (selectedMetrics.has(decodedKey)) {
                selectedMetrics.delete(decodedKey);
                element.classList.remove('selected');
            } else {
                selectedMetrics.add(decodedKey);
                element.classList.add('selected');
            }

            document.getElementById('selectedCount').textContent = `${selectedMetrics.size} selected`;

            if (selectedMetrics.size > 0) {
                renderExploreChart();
                const chartEl = document.getElementById('selectedChart');
                chartEl.style.display = 'block';
                // Smooth scroll to chart after a brief delay to ensure it's rendered
                setTimeout(() => {
                    chartEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                document.getElementById('selectedChart').style.display = 'none';
            }
        }

        async function renderExploreChart() {
            if (selectedMetrics.size === 0) return;

            const now = Date.now();
            const ranges = { '1h': 1, '6h': 6, '24h': 24, '7d': 168 };
            const hours = ranges[currentRange];
            const start = new Date(now - hours * 60 * 60 * 1000).toISOString();
            const end = new Date(now).toISOString();

            const metricNames = new Set();
            metricsData.forEach(m => {
                const key = seriesKey(m);
                if (selectedMetrics.has(key)) {
                    metricNames.add(m.name);
                }
            });

            try {
                const promises = Array.from(metricNames).map(async name => {
                    const response = await fetch(`/v1/query/range?metric=${encodeURIComponent(name)}&start=${start}&end=${end}&maxPoints=500`);
                    if (!response.ok) throw new Error('Range query failed');
                    return response.json();
                });

                const results = await Promise.all(promises);
                const datasets = [];

                results.forEach(result => {
                    if (!result.data) return;

                    result.data.forEach(series => {
                        const key = seriesKey({ name: series.metric, labels: series.labels });
                        if (!selectedMetrics.has(key)) return;

                        const color = getStableColor(series.metric, series.labels);
                        const label = series.labels && Object.keys(series.labels).length > 0
                            ? `${series.metric}{${Object.entries(series.labels).filter(([k]) => !k.startsWith('__')).map(([k, v]) => `${k}="${v}"`).join(', ')}}`
                            : series.metric;

                        datasets.push({
                            label: label,
                            data: series.points.map(p => ({ x: p.t, y: p.v })),
                            borderColor: color,
                            backgroundColor: color + '20',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1
                        });
                    });
                });

                if (exploreChart) exploreChart.destroy();

                const ctx = document.getElementById('exploreChart').getContext('2d');
                exploreChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: '#c9d1d9',
                                    padding: 12,
                                    font: { size: 11, family: "'Monaco', 'Menlo', 'Consolas', monospace" }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                grid: { color: '#30363d' },
                                ticks: { color: '#8b949e' }
                            },
                            y: {
                                grid: { color: '#30363d' },
                                ticks: { color: '#8b949e' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Explore chart error:', error);
            }
        }

        function filterMetrics() {
            renderMetricsBrowser();
        }

        function clearSelection() {
            selectedMetrics.clear();
            document.querySelectorAll('.metric-row').forEach(row => row.classList.remove('selected'));
            document.getElementById('selectedChart').style.display = 'none';
            document.getElementById('selectedCount').textContent = '0 selected';
        }

        function refreshMetrics() {
            selectedMetrics.clear();
            loadMetrics();
        }

        // Search
        document.addEventListener('DOMContentLoaded', () => {
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('input', filterMetrics);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // ESC to clear selection in Explore view
                if (e.key === 'Escape' && currentView === 'explore') {
                    clearSelection();
                }
                // R to refresh current view
                if (e.key === 'r' || e.key === 'R') {
                    if (currentView === 'dashboard') {
                        refreshDashboard();
                    } else {
                        refreshMetrics();
                    }
                }
                // / to focus search (if in explore view)
                if (e.key === '/' && currentView === 'explore' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    searchBox.focus();
                }
            });

            // Initial load
            loadStats();
            loadDashboard();

            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadStats();
                if (currentView === 'dashboard') {
                    refreshDashboard();
                }
            }, 30000);
        });
    </script>
</body>
</html>
